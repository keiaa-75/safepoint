<!--
This Source Code Form is subject to the terms of the Mozilla Public
License, v. 2.0. If a copy of the MPL was not distributed with this
file, You can obtain one at https://www.mozilla.org/MPL/2.0/.
-->

<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">

<head th:replace="~{fragments/admin-common :: head(title='Report Generation')}"></head>
<head>
    <link rel="stylesheet" href="/css/index.css">
    <link rel="stylesheet" href="/css/admin-dashboard.css">
    <link rel="stylesheet" href="/css/report-generation.css">

</head>

<body class="admin-body">
    <div th:replace="~{fragments/modular-nav :: nav(${@navigationConfig.adminNav})}"></div>

    <div class="main-content">
        <div class="container-fluid px-4 py-4 no-print">
            <div id="bento-container" class="mb-4">
                <div class="hero-section">
                    <div class="hero-text">
                        <h1>Report Generation</h1>
                        <p class="lead">Generate monthly reports with statistics and charts for SafePoint data.</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Month Selection Form (show only when no report data) -->
        <div class="container-fluid px-4 py-2 no-print" th:if="${reportData == null}">
            <div class="row justify-content-center">
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="card-title mb-0">Select Month</h5>
                        </div>
                        <div class="card-body">
                            <form th:action="@{/admin/reports/generate}" method="post">
                                <div class="mb-3">
                                    <label for="yearMonth" class="form-label">Choose Month</label>
                                    <select class="form-select" id="yearMonth" name="yearMonth" required>
                                        <option value="">Select a month...</option>
                                        <option th:each="month : ${availableMonths}" 
                                                th:value="${month.value}" 
                                                th:text="${month.display}"
                                                th:attr="data-max-date=${#temporals.format(#temporals.createNow(), 'yyyy-MM')}">
                                        </option>
                                    </select>
                                </div>
                                <div class="d-grid">
                                    <button type="submit" class="btn btn-primary" onclick="return validateMonthSelection(this.form)">Generate Report</button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Report Content (show only when report data exists) -->
        <div class="report-content" th:if="${reportData != null}">
            <!-- Report Header -->
            <div class="report-header">
                <div class="container-fluid">
                    <div class="row align-items-center">
                        <div class="col">
                            <h1 class="report-title">SafePoint Monthly Report</h1>
                            <p class="report-period" th:text="${reportData.monthYearDisplay}">January 2024</p>
                        </div>
                        <div class="col-auto no-print">
                            <button onclick="window.print()" class="btn btn-primary">
                                <i class="bi bi-printer"></i> Print Report
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Summary Statistics -->
            <div class="summary-section">
                <div class="container-fluid">
                    <div class="row g-4 mb-5">
                        <div class="col-md-6 col-lg-3">
                            <div class="summary-card h-100">
                                <div class="summary-icon reports">
                                    <i class="bi bi-file-earmark-text"></i>
                                </div>
                                <div class="summary-content">
                                    <div class="summary-number" th:text="${reportData.totalReports}">0</div>
                                    <div class="summary-label">Total Reports</div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6 col-lg-3">
                            <div class="summary-card h-100">
                                <div class="summary-icon appointments">
                                    <i class="bi bi-calendar-check"></i>
                                </div>
                                <div class="summary-content">
                                    <div class="summary-number" th:text="${reportData.totalAppointments}">0</div>
                                    <div class="summary-label">Total Appointments</div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6 col-lg-3">
                            <div class="summary-card h-100">
                                <div class="summary-icon pending">
                                    <i class="bi bi-clock"></i>
                                </div>
                                <div class="summary-content">
                                    <div class="summary-number" th:text="${(reportData.reportStatusCounts.get('PENDING_REVIEW') ?: 0) + (reportData.reportStatusCounts.get('UNDER_REVIEW') ?: 0)}">0</div>
                                    <div class="summary-label">Pending Reports</div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6 col-lg-3">
                            <div class="summary-card h-100">
                                <div class="summary-icon resolved">
                                    <i class="bi bi-check-circle"></i>
                                </div>
                                <div class="summary-content">
                                    <div class="summary-number" th:text="${reportData.reportStatusCounts.get('RESOLVED') ?: 0}">0</div>
                                    <div class="summary-label">Resolved Reports</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Category Summary -->
            <div class="category-section">
                <div class="container-fluid">
                    <div class="row mb-5">
                        <div class="col-12">
                            <div class="card">
                                <div class="card-header">
                                    <h5>Reports by Category</h5>
                                </div>
                                <div class="card-body">
                                    <div th:if="${#maps.isEmpty(reportData.reportCategoryCounts)}" class="no-data">
                                        No category data available for this month.
                                    </div>
                                    <div class="row" th:unless="${#maps.isEmpty(reportData.reportCategoryCounts)}">
                                        <div th:each="category : ${reportData.reportCategoryCounts}" class="col-md-3 col-sm-6 mb-3">
                                            <div class="category-item">
                                                <div class="category-name" th:text="${category.key}">Category</div>
                                                <div class="category-count" th:text="${category.value}">0</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Status Summary -->
            <div class="status-section">
                <div class="container-fluid">
                    <div class="row mb-5">
                        <div class="col-12">
                            <div class="card">
                                <div class="card-header">
                                    <h5>Status Overview</h5>
                                </div>
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-md-6">
                                            <h6>Report Status</h6>
                                            <div th:each="status : ${reportData.reportStatusCounts}" class="status-item mb-2">
                                                <span class="status-label" th:text="${#strings.replace(status.key, '_', ' ')}">Status</span>
                                                <span class="status-count badge" 
                                                      th:classappend="${status.key == 'RESOLVED' ? 'bg-success' : (status.key == 'PENDING_REVIEW' ? 'bg-warning' : 'bg-info')}"
                                                      th:text="${status.value}">0</span>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <h6>Appointment Status</h6>
                                            <div th:each="status : ${reportData.appointmentStatusCounts}" class="status-item mb-2">
                                                <span class="status-label" th:text="${status.key}">Status</span>
                                                <span class="status-count badge" 
                                                      th:classappend="${status.key == 'COMPLETED' ? 'bg-success' : (status.key == 'CANCELLED' ? 'bg-danger' : (status.key == 'CONFIRMED' ? 'bg-info' : 'bg-warning'))}"
                                                      th:text="${status.value}">0</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Detailed Data Tables -->
            <div class="tables-section">
                <div class="container-fluid">
                    <div class="row mb-5">
                        <!-- Reports Table -->
                        <div class="col-12">
                            <div class="card">
                                <div class="card-header">
                                    <h5>Reports</h5>
                                </div>
                                <div class="card-body">
                                    <div th:if="${#lists.isEmpty(reportData.reports)}" class="no-data">
                                        No reports for this month.
                                    </div>
                                    <div class="table-responsive" th:unless="${#lists.isEmpty(reportData.reports)}">
                                        <table class="table table-striped table-hover">
                                            <thead class="table-light">
                                                <tr>
                                                    <th>Report ID</th>
                                                    <th>Category</th>
                                                    <th>Status</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <tr th:each="report : ${reportData.reports}">
                                                    <td th:text="${report.reportId}">ID-001</td>
                                                    <td th:text="${report.category}">Physical</td>
                                                    <td>
                                                        <span class="badge" 
                                                              th:classappend="${report.status == 'RESOLVED' ? 'bg-success' : (report.status == 'PENDING_REVIEW' ? 'bg-warning' : 'bg-info')}"
                                                              th:text="${#strings.replace(report.status, '_', ' ')}">
                                                            Pending
                                                        </span>
                                                    </td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row mb-5">
                        <!-- Appointments Table -->
                        <div class="col-12">
                            <div class="card">
                                <div class="card-header">
                                    <h5>Appointments</h5>
                                </div>
                                <div class="card-body">
                                    <div th:if="${#lists.isEmpty(reportData.appointments)}" class="no-data">
                                        No appointments for this month.
                                    </div>
                                    <div class="table-responsive" th:unless="${#lists.isEmpty(reportData.appointments)}">
                                        <table class="table table-striped table-hover">
                                            <thead class="table-light">
                                                <tr>
                                                    <th>Appointment ID</th>
                                                    <th>Status</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <tr th:each="appointment : ${reportData.appointments}">
                                                    <td th:text="${'APT-' + appointment.id}">APT-001</td>
                                                    <td>
                                                        <span class="badge" 
                                                              th:classappend="${appointment.status == 'COMPLETED' ? 'bg-success' : (appointment.status == 'CANCELLED' ? 'bg-danger' : (appointment.status == 'CONFIRMED' ? 'bg-info' : 'bg-warning'))}"
                                                              th:text="${appointment.status}">
                                                            Pending
                                                        </span>
                                                    </td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- New Report Button -->
            <div class="container-fluid no-print mt-4">
                <div class="row justify-content-center">
                    <div class="col-auto">
                        <a href="/admin/reports/generate" class="btn btn-secondary">
                            <i class="bi bi-arrow-left"></i> Generate Another Report
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div th:replace="~{fragments/admin-common :: scripts}"></div>
    <script>
        function validateMonthSelection(form) {
            const selectedMonth = form.yearMonth.value;
            if (!selectedMonth) {
                alert('Please select a month to generate a report.');
                return false;
            }
            
            const currentDate = new Date();
            const currentYearMonth = currentDate.getFullYear() + '-' + 
                String(currentDate.getMonth() + 1).padStart(2, '0');
            
            if (selectedMonth > currentYearMonth) {
                alert('Cannot generate reports for future months. Please select a current or past month.');
                return false;
            }
            
            return true;
        }
    </script>
</body>

</html>